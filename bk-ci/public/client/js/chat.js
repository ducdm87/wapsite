function getmsg(b,d){window.timeoutId=window.timeoutId||[];if(b&&!$("#chat_handler_holder").length){$("body").append("<div id='chat_handler_holder'></div>")}var e=getroom();if(b){$("#chatcontent").append('<center class=loadingimg><br><br><img src="'+staticdir+'public/client/images/loading2.gif"></center>')}if(d&&!$("#archiveplace > .loadingimg").length){$("#archiveplace").prepend('<div class=loadingimg style="padding-left:20px"><img src="'+staticdir+'public/client/images/loading7.gif"></div>')}var a=$("#chatcontent").find(".chatmsgline").first();var c=a.length&&a.attr("rel")?a.attr("rel"):"0";window.ajaxObj=window.ajaxObj||[];if(d&&window.ajaxObj.archive){window.ajaxObj.archive.abort()}window.ajaxObj[d?"archive":"getmsg"]=$.ajax({url:uri_root+"chat_chatsrv?get&uid="+uid+(b?"&preload":("&lastid="+(window.lastMsgId?window.lastMsgId:0)))+(d?("&archive&firstid="+c):"")+"&room="+e,timeout:getmsgTimeout,cache:false,success:function(f){window.getmsg_retries=0;if(b){$("#chatcontent > .loadingimg").remove();$("#chatcontent").html('<div style="margin:5px"><a href="#" class="a_grey" onclick="getmsg(0,1); return false">&gt;&gt; Xem nội dung trước</a></div><div id="archiveplace"></div>')}if(d){$("#archiveplace > .loadingimg").remove()}if(f.length>0){parsemsg(f,d,b)}if(!d){window.timeoutId.getmsgTimeoutId=setTimeout("getmsg()",getmsgIntv)}},error:function(f){if(f.statusText!="abort"){if(b){$("#chatcontent > .loadingimg").remove()}if(d){$("#archiveplace > .loadingimg").remove()}if(!d){if(window.getmsg_retries>0){window.getmsg_retries=0;lagerror()}else{window.getmsg_retries=1}window.timeoutId.getmsgTimeoutId=setTimeout(function(){getmsg(b,d)},getmsgIntv*2)}}}})}function lagerror(){var a=$('<span class="errormsg shadow1" style="position:absolute; z-index:200; bottom:20px; right:45px"><span class="erroricon" style="float:left; margin-right:5px">&nbsp;</span> <div style="float:left; display:inline-block; padding-top:5px">Kết nối tới máy chủ bị gián đoạn</span></span>');setTimeout(function(){a.fadeOut("slow")},5000);$("#chatnotiarea").append(a)}function getroom(){return $("#chatcontent").length?1:0}function parsemsg(data,archive,preload){var data=eval("("+data+")");var msgs=data.msgs;var states=data.states;for(var i in states){var sender=states[i];if($("#chat_"+uid+"_"+sender).length>0){showstate(sender)}}var friendrequests=data.friendrequests;for(var i in friendrequests){var request=friendrequests[i];var confirm=$('<a href="#" class="tool_button">Đồng ý</a>');confirm.click(function(){var parent=$(this).parent();friend_confirm(request.uid,function(html){if(html=="ok"){parent.html("Đã chấp nhận");parent.animate({color:"#008000","font-size":"11px"});if(typeof(listfriend)!="undefined"){listfriend(uid)}}else{parent.remove()}});return false});var deny=$('<a href="#" class="tool_button">Từ chối</a>');deny.click(function(){var parent=$(this).parent();friend_deny(request.uid,function(html){if(html=="ok"){parent.html("Đã từ chối");parent.animate({color:"#008000","font-size":"11px"})}else{parent.remove()}});return false});var buttonholder=$("<div></div>");buttonholder.css({"text-align":"center"});buttonholder.append(confirm).append(deny);var noti=$("<div></div>");noti.append("<div><b>"+request.name+"</b> gửi đề nghị kết bạn</div>");noti.append(buttonholder);notify(noti,"friend")}var friendconfirms=data.friendconfirms;for(i in friendconfirms){friendconfirm=friendconfirms[i];var noti=$("<div style='padding:3px 0; cursor:pointer; *cursor:hand'><b>"+friendconfirm.name+"</b> đã nhận lời đề nghị kết bạn, bấm chuột để chat với <b>"+friendconfirm.name+"</b></div>");noti.click(function(){ppchatInit(friendconfirm.friendid,friendconfirm.name,0,1)});notify(noti,"friend");if(typeof(listfriend)!="undefined"){listfriend(uid)}}if(msgs!=null&&msgs.length){var archivecontent="";var is_scroll=is_scrollcontent("chatcontent");var newmsg=0;var newppmsg=0;for(var i in msgs){var msg=msgs[i];var msgid=msg.id;var sname=msg.sname;var rid=msg.rid;var content=msg.content;var msgtime=msg.time;var sid=msg.sid;var utype=msg.utype;if(msg.type==1){var re="<div>"+content+"</div>"}else{var re="<div id='chatmsg_"+msgid+"' class='"+(rid>0?"chatppmsgline":"chatmsgline")+" newmsg' rel='"+msgid+"'><span class='chatid id"+((sid!=uid)?"2":"1")+" "+utype+"' rel='"+sid+"'>"+sname+":</span> <span class='chatmsg newmsg' rel='"+msgtime+"'>"+outputprocess(content)+"</span></div>"}if(archive){archivecontent+=re}else{if(rid&&rid==uid){newppmsg=1;ppchatInit(sid,sname,1);var pp_is_scroll=is_scrollcontent("content_"+uid+"_"+sid);$("#content_"+uid+"_"+sid).append(re);if(pp_is_scroll){scrollcontent("content_"+uid+"_"+sid)}clearstate(sid)}else{newmsg=1;$("#chatcontent").append(re)}window.lastMsgId=msgid}}if(archive){$("#archiveplace").prepend(archivecontent)}else{if(preload||is_scroll){scrollcontent("chatcontent")}}msgtoolinit();chatidinit();timeshowinit();$(".newmsg").removeClass("newmsg");if(newmsg){chatsound("newmsg")}if(newppmsg){chatsound("ppnewmsg")}}}function ppchatArchive(remoteid){var archivediv=$("#chat_"+uid+"_"+remoteid+" > div > .ppchat_content > .ppchat_archive_area");var firstmsg=$("#chat_"+uid+"_"+remoteid).find(".chatppmsgline").first();var firstid=firstmsg.length&&firstmsg.attr("rel")?firstmsg.attr("rel"):"0";if(!archivediv.find(".loadingimg").length){archivediv.prepend('<div class=loadingimg style="padding-left:20px"><img src="'+staticdir+'public/client/images/loading7.gif"></div>')}window.ajaxObj=window.ajaxObj||[];if(window.ajaxObj["archive_"+remoteid]){window.ajaxObj["archive_"+remoteid].abort()}window.ajaxObj["archive_"+remoteid]=$.ajax({url:uri_root+"chat_chatsrv?pparchive&uid="+uid+"&firstid="+firstid+"&remoteid="+remoteid,success:function(html){archivediv.find(".loadingimg").remove();if(html.length){var msgs=eval("("+html+")");var archivecontent="";for(var i in msgs){var msg=msgs[i];var msgid=msg.id;var sname=msg.sname;var rid=msg.rid;var content=outputprocess(msg.content);var msgtime=msg.time;var sid=msg.sid;var utype=msg.utype;var re="<div id='chatmsg_"+msgid+"' class='chatppmsgline newmsg' rel='"+msgid+"'><span class='chatid id"+((sid!=uid)?"2":"1")+" "+utype+"' rel='"+sid+"'>"+(sname!=""?sname:("user_"+sid))+":</span> <span class='chatmsg newmsg' rel='"+msgtime+"'>"+content+"</span></div>";archivecontent+=re}if(archivecontent){archivediv.prepend(archivecontent);timeshowinit();chatidinit();$(".newmsg").removeClass("newmsg")}}else{$("#content_"+uid+"_"+remoteid).find(".archivebutton").remove()}}})}function is_scrollcontent(e){var d=$("#"+e);var c=d.scrollTop();var a=d.height();var b=d[0].scrollHeight;return c>b-a-Math.round(a/3)}function scrollcontent(d,a){var c=$("#"+d);var b=c[0].scrollHeight;if(window.window_focus&&!a){c.animate({scrollTop:b},"slow")}else{c.scrollTop(b)}}function striptags(b){var a=/(<([^>]+)>)/ig;b=b.replace(a,"");return b}function inputprocess(a){a=a.replace("<P>"," ");a=a.replace("</P>","");a=bb_encode(a);a=striptags(a);return a}function outputprocess(a){a=stripnewline(a);a=striptags(a);a=bb_decode(a);a=url2link(a);a=hilightnum(a);a=applyEmoticons(a);a=fixlink(a);return a}function stripnewline(a){return a.replace(/(\r\n|\n|\r)/gm," ")}function bb_encode(a){a=a.replace(/<b>/ig,"[b]");a=a.replace(/<\/b>/ig,"[/b]");a=a.replace(/<i>/ig,"[i]");a=a.replace(/<\/i>/ig,"[/i]");a=a.replace(/<u>/ig,"[u]");a=a.replace(/<\/u>/ig,"[/u]");a=a.replace(/<br>/ig," ");a=a.replace(/<\/br>/ig,"");return a}function bb_decode(a){a=a.replace(/\[b\]/ig,"<b>");a=a.replace(/\[\/b\]/ig,"</b>");a=a.replace(/\[i\]/ig,"<i>");a=a.replace(/\[\/i\]/ig,"</i>");a=a.replace(/\[u\]/ig,"<u>");a=a.replace(/\[\/u\]/ig,"</u>");a=a.replace(/\[br\]/ig,"<br>");a=a.replace(/\[\/br\]/ig,"</br>");return a}function hilightnum(a){return a.replace(/(\d{2,}(?=[^\w]|$))/g,"<span class=hlnum>$1</span>")}function fixlink(b){var a=$("<div>"+b+"</div>");a.find("a").each(function(){$(this).attr("href",striptags($(this).attr("href")));$(this).html(striptags($(this).html()))});return a.html()}function breaklongline(a){return a.replace(/([^ ]{20})/g,'$1<span style="display:inline-block"></span>')}function url2link(b){var a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return b.replace(a,"<a href='$1' target='_blank'>$1</a>")}function sendmsg(msg,contentId,sendmsgid){if(contentId=="chatcontent"){var receiver=0}else{var idinfo=contentId.replace("content_","");idinfo=idinfo.split("_");var receiver=idinfo[1]}if(!msg.replace(/(&nbsp;|<br>)/g,"").match(/\S/)){alert("Xin hãy nhập nội dung tin nhắn.")}else{if(msg.length>msgmaxlength){msg=msg.substr(0,msgmaxlength)}msg=inputprocess(msg);if(msg.length>0){var sendroom=1;if(!sendmsgid){sendmsgid=new Date().getTime();var sendmsgline=$("<div id='msg"+sendmsgid+"' class='"+(receiver?"chatppmsgline":"chatmsgline")+" chatmsgline_sending'><span class='chatid id1' rel='"+uid+"'>"+user+":</span> <span class='chatmsg'>"+outputprocess(msg)+"</span></div>");$("#"+contentId).append(sendmsgline);scrollcontent(contentId)}else{if($("#msg"+sendmsgid).removeClass("chatmsgline_error")){}$("#msg"+sendmsgid).unbind("mouseenter").unbind("mouseleave")}var sendurl=uri_root+"chat_chatsrv?send&uid="+uid+"&receiver="+receiver+"&msg="+encodeURIComponent(msg)+"&room="+sendroom;$.ajax({url:sendurl,timeout:20000,success:function(html){$("#msg"+sendmsgid).removeClass("chatmsgline_sending");$("#msg"+sendmsgid).find(".chatmsg").attr("rel",date.getTime()/1000);timeshowinit($("#msg"+sendmsgid).find(".chatmsg"));if(html.length>0){var re=eval("("+html+")");if(re.msg){$("#"+contentId).append(re.msg);scrollcontent(contentId)}}},error:function(){$("#msg"+sendmsgid).addClass("chatmsgline_error");$("#msg"+sendmsgid).attr("title","Tin nhắn chưa được gửi đi, có thể do kết nối mạng bị ngắt");$("#msg"+sendmsgid).hover(function(){var resendbutton=$('<a href="#" class="resendbutton" title="">Gửi lại</a>');resendbutton.click(function(){$("#msg"+sendmsgid).removeClass("chatmsgline_error");sendmsg(msg,contentId,sendmsgid);$(this).fadeOut("fast");return false});$("#msg"+sendmsgid).append(resendbutton)},function(){$("#msg"+sendmsgid).find(".resendbutton").remove()})}})}}}function msgtoolinit(){if(window.isadmin){$(".chatmsgline.newmsg").hover(function(){$(this).addClass("chatmsgline_hover");var a=$("<a class=closebutton href='#' onclick='"+(window.isadmin?"chat_delmsg":"chat_reportabuse")+'("'+this.id+"\"); return false' title='"+(window.isadmin?"Xóa":"Báo cáo vi phạm")+"'>&nbsp;</a>");$(this).append(a)},function(){$(this).removeClass("chatmsgline_hover");$(this).find(".closebutton").remove()})}}function timeshowinit(a){a=a||".chatmsg.newmsg";$(a).hover(function(){$(this).attr("title","Gửi lúc "+timeshow($(this).attr("rel")))},function(){})}function chatidinit(){window.timeoutId=window.timeoutId||[];$("div.newmsg > .chatid").hover(function(){$(this).addClass("chatid_hover");var a=$(this);var b=$(this).attr("rel");window.timeoutId.userInfoPop=setTimeout(function(){userinfopop(a,b)},500)},function(){$(this).removeClass("chatid_hover");clearTimeout(window.timeoutId.userInfoPop);hideuserinfopop(this)}).click(function(){var b=$(this).attr("rel");var a=$("<div>"+$(this).html()+"</div>");a.find("span").remove();a=a.html();a=a.slice(0,a.length-1);ppchatInit(b,a,0,1)})}function chat_reportabuse(b){if(confirm("Bạn cho rằng nội dung này phản cảm hoặc không phù hợp?")){$("#"+b).addClass("chatmsgline_removing");var a=b.replace("chatmsg_","");$.ajax({url:uri_root+"client/chat/chat_abuse?report&reporter="+uid+"&msgid="+a,success:function(c){chat_hidemsg(b)}})}}function chat_delmsg(b){$("#"+b).addClass("chatmsgline_removing");var a=b.replace("chatmsg_","");$.ajax({url:uri_root+"chat_chatsrv?del="+a,success:function(c){if(c=="ok"){chat_hidemsg(b)}}})}function chat_hidemsg(a){$("#"+a).remove()}function chatsubmit(a,b){if(loggedin){sendmsg(a,b)}else{alert("Bạn phải đăng nhập mới có thể tham gia chat")}}var emoticons=[[":)","1.gif","cười mỉm"],[":(","2.gif","buồn chán"],[";)","3.gif","đá lông nheo"],[":D","4.gif","cười nhăn răng"],[";;)","5.gif","mắt chớp chớp"],["&gt;:D&lt;","6.gif","ôm"],[":-/","7.gif","khó hiểu"],[":x","8.gif","kết rồi đấy"],[':"&gt;',"9.gif","xấu hổ"],[":P","10.gif","lẽ lưỡi"],[":-*","11.gif","hôn"],["=((","12.gif","vỡ tim"],[":-O","13.gif","ngạc nhiên"],["X(","14.gif","tức giận"],[":&gt;","15.gif","tự tin"],["B-)","16.gif","sành điệu"],[":-S","17.gif","lo lắng"],["#:-S","18.gif","mệt quá"],["&gt;:)","19.gif","quỷ sứ"],[":((","20.gif","khóc nức nở"],[":))","21.gif","cười to"],[":|","22.gif","nghiêm túc đấy"],["=))","24.gif","cười lăn lộn"],[":-c","101.gif","gọi điện"],["~X(","102.gif","vò đầu"],[":-h","103.gif","tạm biệt"],[":-t","104.gif","nhanh lên"],["8-&gt;","105.gif","mơ mộng"],["I-)","28.gif","ngủ rồi"],["8-|","29.gif","chịu thôi"],["[-(","33.gif","bó tay"],["8-}","35.gif","ngây dại"],["(:|","37.gif","ngáp"],["=P~","38.gif","nhỏ dãi"],[":-?","39.gif","suy nghĩ"],["#-o","40.gif","ôi trời"],["=D&gt;","41.gif","hoan hô"],[":-SS","42.gif","ặc ặc"],["@-)","43.gif","thôi miên"],[":^o","44.gif","điêu"],[":-w","45.gif","đang chờ đây"],[":-&lt;","46.gif","thờ dài"],["&gt;:P","47.gif","ọe"],["X_X","109.gif","không dám nhìn"],[":!!","110.gif","muộn rồi"],[":m/","111.gif","phang mạnh vào"],[":-q","112.gif","không được"],[":-bd","113.gif","đồng ý 2 tay"],["^#(^","114.gif","không phải iem"],[":-??","106.gif","chẳng biết"],["%-(","107.gif","bịt tai"],[":@)","49.gif","lợn"],["3:-O","50.gif","bò"],[":(|)","51.gif","khỉ"],["~:&gt;","52.gif","gà"],["@};-","53.gif","hoa hồng"],["~O)","57.gif","cà fê"],["*-:)","58.gif","sáng kiến"],["8-X","59.gif","đầu lâu"],["[-O&lt;","63.gif","cầu trời phật"],["$-)","64.gif","nhìn thấy tiền"],[':-"',"65.gif","huýt sáo"],["b-(","66.gif","đấm vào mặt"],[":)&gt;-","67.gif","chiến thắng"],["[-X","68.gif","không được đâu"],["\\:D/","69.gif","hí hửng"],["&gt;:/","70.gif","mang đây"],[";))","71.gif","cười khúc khích"],["^:)^","77.gif","xin lạy"],[":-j","78.gif","vô tư đi"],[":-$","32.gif","bí mật"],["(*)","79.gif","sao"]];function applyEmoticons(c){for(var a=emoticons.length-1;a>=0;a--){var b=new RegExp("("+preg_quote(emoticons[a][0])+")","gi");c=c.replace(b,'<img class="emoticon" src="'+staticdir+"public/client/images/emoticons/"+emoticons[a][1]+'" alt="('+emoticons[a][2]+')" title="'+emoticons[a][2]+'">')}return c}function preg_quote(a){return(a+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1")}function chatsound(d){if(playchatsound){var a=new FlashObject(staticdir+"public/client/images/"+d+".swf","msgsound","1","1","6","#FFFFFF");a.addParam("loop","false");a.addParam("wmode","transparent");var c=new Date().getTime();var b=$("<div id='cs"+c+"' style='position:absolute; top:-100px; width:1px; height:1px; overflow:hidden'></div>");setTimeout(function(){b.remove()},5000);$("body").append(b);a.write("cs"+c)}}function exec(b,c){var a=document.getElementById(b).contentWindow.document;a.execCommand(c,false,null)}function color(a){Editor.execCommand("forecolor",false,a)}function getRange(a){var c;if(document.all){c=frames[a];var b=c.document.selection;if(b!=null){rng=b.createRange()}}else{c=document.getElementById(a).contentWindow;var b=c.getSelection();rng=b.getRangeAt(b.rangeCount-1).cloneRange()}return rng}function rteInsertHTML(b,d){var a=document.getElementById(d).contentWindow.document;if(document.all){frames[d].focus();var c=a.selection.createRange();c.pasteHTML(b);c.collapse(false);c.select()}else{$("#"+d).focus();a.execCommand("insertHTML",false,b)}}function insertEmoticon(b,a){rteInsertHTML(" "+b,a)}function emoticonBar(a,b){a="#"+a;$(a).append("<a class='icon_toolbar' href='#' title='Chèn biểu tượng cảm xúc'><img border=0 src='"+staticdir+"public/client/images/emoticons/1.gif' style='margin:3px'><span class='allicon_holder'></span></a>");$("html").click(function(){$(a).find(".allicon_holder").hide();$(a).find(".icon_toolbar").removeClass("icon_toolbar_active")});$(".allicon_holder").click(function(c){c.stopPropagation();return false});$(a).find(".icon_toolbar").click(function(){if($(this).find(".allicon_holder").html()==""){var c="";for(i=0;i<emoticons.length;i++){c+="<a class='icon_bar_item' unselectable='on' href='#' title='"+emoticons[i][2]+"' onclick='insertEmoticon(\""+quotesc(emoticons[i][0])+'","'+b+"\"); return false'><img border=0 src='"+staticdir+"public/client/images/emoticons/"+emoticons[i][1]+"' alt='"+quotesc(emoticons[i][0])+"'></a>"}}$(this).find(".allicon_holder").html(c);$(this).find(".allicon_holder > .icon_bar_item").click(function(){var d=$(this).parent();d.hide();d.parent().removeClass("icon_toolbar_active")});$(this).find(".allicon_holder").show();$(this).addClass("icon_toolbar_active");$(this).find("span > a.icon_bar_item").click(function(){$(this).find(".allicon_holder").hide();$(this).removeClass("icon_toolbar_active")});return false})}function quotesc(a){a=a.replace(/([\'])/g,"&quot;");a=a.replace(/([\\\"])/g,"\\$1");return a}function initEditor(d,e){var b=document.getElementById(d).contentWindow.document;b.designMode="on";var a='<html><body style="padding:3px; margin:0 '+(d=="chat_editor"?"45":"20")+'px 0 0; font-family:arial; font-size:13px"></body></html>';if(!operamini){b.open();b.write(a);b.close()}$(b).keypress(function(f){if(f.keyCode==13&&!f.shiftKey){chatsubmit(b.body.innerHTML,e);b.body.innerHTML="";return false}else{chatStateUpdate(d)}window_focus=true});var c=$("#"+d).parent();$(c).find(".chat_send_button").click(function(){chatsubmit(b.body.innerHTML,e);b.body.innerHTML="";return false})}function ppchatInit(c,f,d,g){var e=uid+"_"+c;if($("#chat_"+e).length<1){f=f.replace(/"/g,"&quot;");ppchatCreateHandler(c,f);var b=$('<div id="chat_'+e+'" class="ppchat_holder" rel="'+f+'" title="'+f+'" style="padding:0; background:#F5F5F5; overflow:hidden"></div>');b.append('<div style="padding:0 2px 1px 2px"><div class="ppchat_content" id="content_'+e+'"></div></div>');b.append('<div style="padding:0 2px" class="ppchat_toolsholder"><div id="emoticonbar_'+e+'" style="float:left"></div> <div id="chatstate_'+e+'" style="float:left; margin-left:20px; padding-top:5px; font-size:11px; color:#7D7D7D"></div></div><div style="clear:both"></div>');b.append('<div style="margin:0 2px 5px 2px; border:#DBDBDB 1px solid; position:relative"><iframe id="chat_editor_'+e+'" class="ppchat_editor" frameborder=0></iframe><a class="tool_button chat_send_button" style="padding:3px 5px; position:absolute; right:1px; top:1px" href="#" title="Gửi">▲</a></div>');$("body").append(b);emoticonBar("emoticonbar_"+e,"chat_editor_"+e);$("#chat_"+e).dialog({width:350,dialogClass:"ppchatDlg",modal:false,autoOpen:false,close:function(){$("#chathandler_"+e).removeClass("ppchathandler_newmsg ppchathandler_active")},focus:function(){ppchatCreateHandlerActive("chathandler_"+e);$("#chathandler_"+e).removeClass("ppchathandler_newmsg");if(typeof(notiClear)!="undefined"){notiClear("msg")}},resize:function(){$(this).find(".ppchat_content").css("height",$(this).height()-64)}}).height("auto");initEditor("chat_editor_"+e,"content_"+e);if(d){chatsound("ppchatopen");if(typeof(notify)!="undefined"){var a=$("<div style='padding:3px 0; cursor:pointer; *cursor:hand'><b>"+f+"</b> gửi tin nhắn cho bạn</div>");a.click(function(){ppchatInit(c,f,0,1)});notify(a,"msg")}}ppinfo(c,f)}if(d){if(!$("#chathandler_"+e).hasClass("ppchathandler_active")&&!$("#chathandler_"+e).hasClass("ppchathandler_newmsg")){$("#chathandler_"+e).addClass("ppchathandler_newmsg");flashChatHandler("chathandler_"+e)}if(!window_focus){new_title=f+" gửi tin nhắn cho bạn";flipTitle()}}if(g){if($("#chat_"+e).dialog("isOpen")!=true){$("#chat_"+e).dialog("open")}else{$("#chat_"+e).dialog("close");$("#chat_"+e).dialog("open")}scrollcontent("content_"+e,1);$("#chat_editor_"+e)[0].contentWindow.focus()}return false}function ppinfo(remoteid,remoteName){var suffix=uid+"_"+remoteid;$.ajax({url:uri_root+"chat_chatsrv?ppinfo&uid="+uid+"&remoteid="+remoteid,success:function(html){if(html.length){var info=eval("("+html+")");ppfriendmenu(remoteid,info);var contentdiv=$("#chat_"+uid+"_"+remoteid+" > div > .ppchat_content");if(!info.online){var notice=$("<div class=chatnotice><span style='color:#454545'>"+remoteName+"</span> hiện không trực tuyến và sẽ nhận được tin nhắn của bạn khi đăng nhập.</div>");closable(notice);contentdiv.prepend(notice)}if(info.banned){var notice=$("<div class=chatnotice><span style='color:#454545'>"+remoteName+"</span> đã bị cấm chat nên sẽ không thể trả lời tin nhắn của bạn.</div>");closable(notice);contentdiv.prepend(notice)}if(info.ignored){var notice=$("<div class=chatnotice>Bạn đang chặn tin nhắn từ <span style='color:#454545'>"+remoteName+"</span> nên sẽ không nhận được phản hồi từ thành viên này.</div>");closable(notice);contentdiv.prepend(notice)}if(info.haschat){var button=$('<div style="padding:3px" class="archivebutton"><a href="#" class="a_grey">&gt;&gt; Xem nội dung chat cũ</a></div>');button.find("a").click(function(){ppchatArchive(remoteid);return false});contentdiv.prepend('<div class="ppchat_archive_area" rel="'+(info.haschat*1+1)+'"></div>').prepend(button)}}}})}function ppfriendmenu(a,c){var e=$('<a href="#" class="chat_friend_holder" style="display:none"></a>');var d=$('<div class="chat_friend_menu"></div>');if(c.ignored){var b=$('<span class="chat_friend_icon chat_friend_icon_ignored" title="Bạn đang chặn tin nhắn từ thành viên này, bấm chuột để bỏ chặn">&nbsp;</span>');b.click(function(){unignore(a)})}else{var b=$('<span class="chat_friend_icon chat_friend_icon_ignore" title="Từ chối tin nhắn">&nbsp;</span>');b.click(function(){ignore(a)})}b.hover(function(){$(this).addClass("chat_friend_icon_hover")},function(){$(this).removeClass("chat_friend_icon_hover")});d.append(b);if(c.isfriend){var b=$('<span class="chat_friend_icon chat_friend_icon_del" title="Xóa khỏi danh sách bạn bè">&nbsp;</span>');b.click(function(){delfriend(a)})}else{if(c.requested){var b=$('<span class="chat_friend_icon chat_friend_icon_requested" title="Yêu cầu kết bạn đã được gửi, bấm để gửi lại lần nữa">&nbsp;</span>');b.click(function(){addfriend(a)})}else{var b=$('<span class="chat_friend_icon chat_friend_icon_add" title="Gửi yêu cầu kết bạn">&nbsp;</span>');b.click(function(){addfriend(a)})}}b.hover(function(){$(this).addClass("chat_friend_icon_hover")},function(){$(this).removeClass("chat_friend_icon_hover")});d.append(b);e.hover(function(){$(this).find(".chat_friend_menu").show()},function(){$(this).find(".chat_friend_menu").hide()}).click(function(){return false});e.append('<span class="chat_friend_icon chat_friend_icon_'+(c.isfriend?"valid":"option")+'">&nbsp;</span>');e.append(d);$("#chat_"+uid+"_"+a+" > .ppchat_toolsholder").append(e)}function addfriend(a){$.ajax({url:uri_root+"chat_friend?add&uid="+uid+"&remoteid="+a,success:function(b){if(b=="ok"){$("#chat_"+uid+"_"+a+" > .ppchat_toolsholder > .chat_friend_holder > .chat_friend_menu > .chat_friend_icon_add").removeClass("chat_friend_icon_add").addClass("chat_friend_icon_requested").attr("title","Yêu cầu kết bạn đã được gửi");if(typeof(notify)!="undefined"){floatnotify("<div>Yêu cầu kết bạn đã được gửi</div>")}}}})}function delfriend(a){$.ajax({url:uri_root+"chat_friend?del&uid="+uid+"&remoteid="+a,success:function(b){if(b=="ok"){$("#chat_"+uid+"_"+a+" > .ppchat_toolsholder > .chat_friend_holder > .chat_friend_menu > .chat_friend_icon_del").removeClass("chat_friend_icon_del").addClass("chat_friend_icon_add").unbind("click").click(function(){addfriend(a)}).attr("title","Gửi yêu cầu kết bạn");if(typeof(listfriend)!="undefined"){listfriend(uid)}}}})}function friend_confirm(a,b){$.ajax({url:uri_root+"chat_friend?confirm&uid="+uid+"&remoteid="+a,success:function(c){if(b){b(c)}}})}function friend_deny(a,b){$.ajax({url:uri_root+"chat_friend?deny&uid="+uid+"&remoteid="+a,success:function(c){if(b){b(c)}}})}function ignore(a){$.ajax({url:uri_root+"chat_friend?ignore&uid="+uid+"&remoteid="+a,success:function(b){if(b=="ok"){$("#chat_"+uid+"_"+a+" > .ppchat_toolsholder > .chat_friend_holder > .chat_friend_menu > .chat_friend_icon_ignore").removeClass("chat_friend_icon_ignore").addClass("chat_friend_icon_ignored").unbind("click").click(function(){unignore(a)}).attr("title","Xóa khỏi danh sách từ chối")}}})}function unignore(a){$.ajax({url:uri_root+"chat_friend?unignore&uid="+uid+"&remoteid="+a,success:function(b){if(b=="ok"){$("#chat_"+uid+"_"+a+" > .ppchat_toolsholder > .chat_friend_holder > .chat_friend_menu > .chat_friend_icon_ignored").removeClass("chat_friend_icon_ignored").addClass("chat_friend_icon_ignore").unbind("click").click(function(){ignore(a)}).attr("title","Từ chối tin nhắn")}}})}function ppchatCreateHandler(a,e){var d=uid+"_"+a;if($("#chathandler_"+d).length<1){var c=$("<span class='ppchathandler' id='chathandler_"+d+"'>"+e+"</span>");var b=$("<a href='#' class='closebutton_round'>&nbsp;</a>");$(b).click(function(){$("#chat_"+d).remove();$(this).parent().remove();return false});c.append(b);$(c).hover(function(){$(this).addClass("ppchathandler_hover")},function(){$(this).removeClass("ppchathandler_hover")}).click(function(){ppchatInit(a,e,0,1);ppchatCreateHandlerActive("chathandler_"+d)});$("#chat_handler_holder").prepend(c)}}function ppchatCreateHandlerActive(a){$(".ppchathandler").removeClass("ppchathandler_active");$("#"+a).addClass("ppchathandler_active")}function flashChatHandler(a){if($("#"+a).hasClass("ppchathandler_newmsg")){if($("#"+a).hasClass("ppchathandler_newmsg_flash")){$("#"+a).removeClass("ppchathandler_newmsg_flash")}else{$("#"+a).addClass("ppchathandler_newmsg_flash")}setTimeout('flashChatHandler("'+a+'")',500)}else{$("#"+a).removeClass("ppchathandler_newmsg_flash")}}function flipTitle(){if(!window_focus){if(document.title==orig_title){document.title=new_title}else{document.title=orig_title}if(window.timeoutId.flipTitle){clearTimeout(window.timeoutId.flipTitle)}window.timeoutId.flipTitle=setTimeout("flipTitle()",1000)}else{document.title=orig_title}}function chatStateUpdate(editorId){if(editorId!="chat_editor"){var time=date.getTime();if($("#"+editorId).attr("rel")){var currstate=eval("("+$("#"+editorId).attr("rel")+")")}else{var currstate={lasttyping:0}}if(time-currstate.lasttyping>10000){var info=editorId.replace("chat_editor_","");info=info.split("_");$.ajax({url:uri_root+"chat_stateupdate?sender="+info[0]+"&receiver="+info[1],type:"PUT"});$("#"+editorId).attr("rel","{lasttyping:"+time+"}")}}}function showstate(remoteid){var senderName=$("#chat_"+uid+"_"+remoteid).attr("rel");$("#chatstate_"+uid+"_"+remoteid).html(senderName+" đang gõ tin nhắn...");if(eval("window.stateClearTimeout"+uid+"_"+remoteid)){clearTimeout(eval("window.stateClearTimeout"+uid+"_"+remoteid))}var timeout=setTimeout("$('#chatstate_"+uid+"_"+remoteid+"').html('')",5000);eval("window.stateClearTimeout"+uid+"_"+remoteid+"=timeout")}function clearstate(remoteid){if(eval("window.stateClearTimeout"+uid+"_"+remoteid)){clearTimeout(eval("window.stateClearTimeout"+uid+"_"+remoteid))}$("#chatstate_"+uid+"_"+remoteid).html("")};